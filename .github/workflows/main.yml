name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # pre-commit: lint, format, and static checks
  # ---------------------------------------------------------------------------
  pre-commit:
    name: pre-commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files

  # ---------------------------------------------------------------------------
  # build: configure -> build -> test
  # ---------------------------------------------------------------------------
  build:
    name: Build / ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows
            os: windows-latest
            preset: default-msvc

          - name: Linux
            os: ubuntu-latest
            preset: default-unix

    steps:
      - uses: actions/checkout@v4

      # ---- System dependencies -----------------------------------------------

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -q
          sudo apt-get install -y ninja-build curl zip unzip tar pkg-config \
            libgl1-mesa-dev libglu1-mesa-dev libvulkan-dev \
            libxinerama-dev libxcursor-dev xorg-dev

      # ---- vcpkg setup -------------------------------------------------------
      # Windows runners ship with vcpkg at VCPKG_INSTALLATION_ROOT.
      # Linux: clone and bootstrap a fresh instance.
      # A workspace-local binary cache is used so actions/cache can persist it.

      - name: Set up vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" | `
            Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKG_DEFAULT_BINARY_CACHE=$env:GITHUB_WORKSPACE\.vcpkg-cache" | `
            Out-File -FilePath $env:GITHUB_ENV -Append
          New-Item -ItemType Directory -Force "$env:GITHUB_WORKSPACE\.vcpkg-cache" | Out-Null

      - name: Set up vcpkg (Linux)
        if: runner.os != 'Windows'
        run: |
          git clone https://github.com/microsoft/vcpkg.git "${{ github.workspace }}/vcpkg"
          "${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg"          >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_BINARY_CACHE=${{ github.workspace }}/.vcpkg-cache" >> "$GITHUB_ENV"
          mkdir -p "${{ github.workspace }}/.vcpkg-cache"

      - name: Cache vcpkg binary packages
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.vcpkg-cache
          key: vcpkg-${{ matrix.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ matrix.os }}-

      # ---- CMake configure / build / test ------------------------------------

      - name: Configure
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        run: ctest --preset ${{ matrix.preset }}
